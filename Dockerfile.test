FROM openjdk:21-jdk-slim

# Install required tools
RUN apt-get update && apt-get install -y \
    curl \
    maven \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy parent POM and module POMs
COPY pom.xml .
COPY common/pom.xml ./common/
COPY sqs-redis-bridge/pom.xml ./sqs-redis-bridge/
COPY mc-auth/pom.xml ./mc-auth/

# Copy source files
COPY common/src ./common/src
COPY sqs-redis-bridge/src ./sqs-redis-bridge/src
COPY mc-auth/src ./mc-auth/src

# Download dependencies for all modules
RUN mvn dependency:go-offline -B

# Default command for running integration tests
CMD ["mvn", "test", "-Dtest=**/*IntegrationTest", "-DRun_Integration_Tests=true"]